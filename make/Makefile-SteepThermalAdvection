# $1 -- resolution
define SteepTerrainMeshes

$(eval $(call BlockMesh,build/steepThermalAdvection-mesh-noOrography-$1,src/steepThermalAdvection/mesh-noOrography-$1))
$(eval $(call TerrainFollowingMesh,build/steepThermalAdvection-mesh-btf-$1,build/steepThermalAdvection-mesh-noOrography-$1,src/steepThermalAdvection/mesh-btf))
$(eval $(call SlantedCellMesh,build/steepThermalAdvection-mesh-slantedCell-$1,build/steepThermalAdvection-mesh-noOrography-$1,src/steepThermalAdvection/mesh-slantedCell))
$(eval $(call CutCellMesh,build/steepThermalAdvection-mesh-cutCell-$1,src/steepThermalAdvection/mesh-cutCell-$1,src/steepThermalAdvection/createPatchDict))

endef

# $1 -- case
# $2 -- mesh
# $3 -- timestep
# $4 -- advection scheme
define SteepTerrainTest

$(eval $(call StandaloneThermalAdvection,$1,$2,src/gravityWaves/$(thetaInit),src/steepThermalAdvection/velocityField,$3,6000,src/steepThermalAdvection/environmentalProperties,$4 src/advection/system/commonFvSchemes))

all-steepThermalAdvection-maxCourantNumbers: $1/maxCo.txt

endef

# $1 -- meshType (e.g. btf)
# $2 -- resolution
# $3 -- timestep
define SteepTerrainTests

$(eval $(call SteepTerrainTest,build/steepThermalAdvection-$1-linearUpwind-$2,build/steepThermalAdvection-mesh-$1-$2,$3,src/advection/system/linearUpwind))
$(eval $(call SteepTerrainTest,build/steepThermalAdvection-$1-cubicUpwind-$2,build/steepThermalAdvection-mesh-$1-$2,$3,src/advection/system/cubicUpwindCPCFit))

endef

# $1 -- error filename
# $2 -- resolutions
define SteepTerrainCollation

$(eval $(call CollateErrors,build/steepThermalAdvection-btf-linearUpwind-,$1,$2))
$(eval $(call CollateErrors,build/steepThermalAdvection-btf-cubicUpwind-,$1,$2))
$(eval $(call CollateErrors,build/steepThermalAdvection-slantedCell-linearUpwind-,$1,$2))
$(eval $(call CollateErrors,build/steepThermalAdvection-slantedCell-cubicUpwind-,$1,$2))
$(eval $(call CollateErrors,build/steepThermalAdvection-cutCell-linearUpwind-,$1,$2))
$(eval $(call CollateErrors,build/steepThermalAdvection-cutCell-cubicUpwind-,$1,$2))

all-steepThermalAdvection-convergence: \
  build/steepThermalAdvection-btf-linearUpwind-collated/$1 \
  build/steepThermalAdvection-btf-cubicUpwind-collated/$1 \
  build/steepThermalAdvection-slantedCell-linearUpwind-collated/$1 \
  build/steepThermalAdvection-slantedCell-cubicUpwind-collated/$1 \
  build/steepThermalAdvection-cutCell-linearUpwind-collated/$1 \
  build/steepThermalAdvection-cutCell-cubicUpwind-collated/$1

endef

$(eval $(call SteepTerrainMeshes,5000))
$(eval $(call SteepTerrainMeshes,2500))
$(eval $(call SteepTerrainMeshes,2000))
$(eval $(call SteepTerrainMeshes,1250))
$(eval $(call SteepTerrainMeshes,1000))
$(eval $(call SteepTerrainMeshes,667))
$(eval $(call SteepTerrainMeshes,500))
$(eval $(call SteepTerrainMeshes,333))
$(eval $(call SteepTerrainMeshes,250))
$(eval $(call SteepTerrainMeshes,125))
#$(eval $(call SteepTerrainMeshes,100))

$(eval $(call SteepTerrainTests,btf,5000,200))
$(eval $(call SteepTerrainTests,btf,2500,100))
$(eval $(call SteepTerrainTests,btf,2000,100))
$(eval $(call SteepTerrainTests,btf,1250,50))
$(eval $(call SteepTerrainTests,btf,1000,50))
$(eval $(call SteepTerrainTests,btf,667,25))
$(eval $(call SteepTerrainTests,btf,500,20))
$(eval $(call SteepTerrainTests,btf,333,10))
$(eval $(call SteepTerrainTests,btf,250,10))
$(eval $(call SteepTerrainTests,btf,125,5))
#$(eval $(call SteepTerrainTests,btf,100,5))

$(eval $(call SteepTerrainTests,slantedCell,5000,50))
$(eval $(call SteepTerrainTests,slantedCell,2500,20))
$(eval $(call SteepTerrainTests,slantedCell,2000,10))
$(eval $(call SteepTerrainTests,slantedCell,1250,10))
$(eval $(call SteepTerrainTests,slantedCell,1000,5))
$(eval $(call SteepTerrainTests,slantedCell,667,5))
$(eval $(call SteepTerrainTests,slantedCell,500,2.5))
$(eval $(call SteepTerrainTests,slantedCell,333,2))
$(eval $(call SteepTerrainTests,slantedCell,250,1))
$(eval $(call SteepTerrainTests,slantedCell,125,0.5))
#$(eval $(call SteepTerrainTests,slantedCell,100,0.5))

$(eval $(call SteepTerrainTests,cutCell,5000,3))
$(eval $(call SteepTerrainTests,cutCell,2500,1.5))
$(eval $(call SteepTerrainTests,cutCell,2000,1))
$(eval $(call SteepTerrainTests,cutCell,1250,0.75))
$(eval $(call SteepTerrainTests,cutCell,1000,0.5))
$(eval $(call SteepTerrainTests,cutCell,667,0.3))
$(eval $(call SteepTerrainTests,cutCell,500,0.3))
$(eval $(call SteepTerrainTests,cutCell,333,0.2))
#$(eval $(call SteepTerrainTests,cutCell,250,0.2))
#$(eval $(call SteepTerrainTests,cutCell,125,0.1))
#$(eval $(call SteepTerrainTests,cutCell,100,1))

$(eval $(call MakeDir,build/steepThermalAdvection-btf-linearUpwind-collated/18000))
$(eval $(call MakeDir,build/steepThermalAdvection-btf-cubicUpwind-collated/18000))
$(eval $(call MakeDir,build/steepThermalAdvection-slantedCell-linearUpwind-collated/18000))
$(eval $(call MakeDir,build/steepThermalAdvection-slantedCell-cubicUpwind-collated/18000))
$(eval $(call MakeDir,build/steepThermalAdvection-cutCell-linearUpwind-collated/18000))
$(eval $(call MakeDir,build/steepThermalAdvection-cutCell-cubicUpwind-collated/18000))

$(eval $(call SteepTerrainCollation,18000/l2errorT.txt,5000 2500 2000 1250 1000 667 500 333))
$(eval $(call SteepTerrainCollation,18000/linferrorT.txt,5000 2500 2000 1250 1000 667 500 333))

.PHONY: all-steepThermalAdvection-convergence all-steepThermalAdvection-maxCourantNumbers
