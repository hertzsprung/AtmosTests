# $1 -- resolution
define SteepTerrainMeshes

$(eval $(call BlockMesh,build/steepThermalAdvection-mesh-noOrography-$1,src/steepThermalAdvection/mesh-noOrography-$1))
$(eval $(call TerrainFollowingMesh,build/steepThermalAdvection-mesh-btf-$1,build/steepThermalAdvection-mesh-noOrography-$1,src/steepThermalAdvection/mesh-btf))
$(eval $(call SlantedCellMesh,build/steepThermalAdvection-mesh-slantedCell-$1,build/steepThermalAdvection-mesh-noOrography-$1,src/steepThermalAdvection/mesh-slantedCell))
$(eval $(call CutCellMesh,build/steepThermalAdvection-mesh-cutCell-$1,src/steepThermalAdvection/mesh-cutCell-$1,src/steepThermalAdvection/createPatchDict))

endef

# $1 -- case
# $2 -- mesh
# $3 -- timestep
# $4 -- advection scheme
define SteepTerrainTest

$(eval $(call StandaloneThermalAdvection,$1,$2,src/gravityWaves/$(thetaInit),src/steepThermalAdvection/velocityField,$3,6000,src/steepThermalAdvection/environmentalProperties,$4 src/advection/system/commonFvSchemes))

all-steepThermalAdvection-maxCourantNumbers: $1/maxCo.txt

endef

# $1 -- resolution
# $2 -- timestep
define SteepTerrainTests

$(eval $(call SteepTerrainTest,build/steepThermalAdvection-btf-linearUpwind-$1,build/steepThermalAdvection-mesh-btf-$1,$2,src/advection/system/linearUpwind))
$(eval $(call SteepTerrainTest,build/steepThermalAdvection-btf-cubicUpwind-$1,build/steepThermalAdvection-mesh-btf-$1,$2,src/advection/system/cubicUpwindCPCFit))
$(eval $(call SteepTerrainTest,build/steepThermalAdvection-slantedCell-linearUpwind-$1,build/steepThermalAdvection-mesh-slantedCell-$1,$2,src/advection/system/linearUpwind))
$(eval $(call SteepTerrainTest,build/steepThermalAdvection-slantedCell-cubicUpwind-$1,build/steepThermalAdvection-mesh-slantedCell-$1,$2,src/advection/system/cubicUpwindCPCFit))
$(eval $(call SteepTerrainTest,build/steepThermalAdvection-cutCell-linearUpwind-$1,build/steepThermalAdvection-mesh-cutCell-$1,$2,src/advection/system/linearUpwind))
$(eval $(call SteepTerrainTest,build/steepThermalAdvection-cutCell-cubicUpwind-$1,build/steepThermalAdvection-mesh-cutCell-$1,$2,src/advection/system/cubicUpwindCPCFit))

endef

# $1 -- error filename
# $2 -- resolutions
define SteepTerrainCollation

$(eval $(call CollateErrors,build/steepThermalAdvection-btf-linearUpwind-,$1,$2))
$(eval $(call CollateErrors,build/steepThermalAdvection-btf-cubicUpwind-,$1,$2))
$(eval $(call CollateErrors,build/steepThermalAdvection-slantedCell-linearUpwind-,$1,$2))
$(eval $(call CollateErrors,build/steepThermalAdvection-slantedCell-cubicUpwind-,$1,$2))
$(eval $(call CollateErrors,build/steepThermalAdvection-cutCell-linearUpwind-,$1,$2))
$(eval $(call CollateErrors,build/steepThermalAdvection-cutCell-cubicUpwind-,$1,$2))

all-steepThermalAdvection-convergence: \
  build/steepThermalAdvection-btf-linearUpwind-collated/$1 \
  build/steepThermalAdvection-btf-cubicUpwind-collated/$1 \
  build/steepThermalAdvection-slantedCell-linearUpwind-collated/$1 \
  build/steepThermalAdvection-slantedCell-cubicUpwind-collated/$1 \
  build/steepThermalAdvection-cutCell-linearUpwind-collated/$1 \
  build/steepThermalAdvection-cutCell-cubicUpwind-collated/$1

endef

$(eval $(call SteepTerrainMeshes,5000))
$(eval $(call SteepTerrainMeshes,2500))
$(eval $(call SteepTerrainMeshes,2000))
$(eval $(call SteepTerrainMeshes,1250))
$(eval $(call SteepTerrainMeshes,1000))
$(eval $(call SteepTerrainMeshes,667))
$(eval $(call SteepTerrainMeshes,500))
$(eval $(call SteepTerrainMeshes,333))
$(eval $(call SteepTerrainMeshes,250))
$(eval $(call SteepTerrainMeshes,125))
$(eval $(call SteepTerrainMeshes,100))

$(eval $(call SteepTerrainTests,5000,8))
$(eval $(call SteepTerrainTests,2500,4))
$(eval $(call SteepTerrainTests,2000,2))
$(eval $(call SteepTerrainTests,1250,1))
$(eval $(call SteepTerrainTests,1000,1))
$(eval $(call SteepTerrainTests,667,1))
$(eval $(call SteepTerrainTests,500,1))
$(eval $(call SteepTerrainTests,333,1))
$(eval $(call SteepTerrainTests,250,1))
$(eval $(call SteepTerrainTests,125,1))
$(eval $(call SteepTerrainTests,100,1))

$(eval $(call MakeDir,$(dir build/steepThermalAdvection-btf-linearUpwind-collated/18000)))
$(eval $(call MakeDir,$(dir build/steepThermalAdvection-btf-cubicUpwind-collated/18000)))
$(eval $(call MakeDir,$(dir build/steepThermalAdvection-slantedCell-linearUpwind-collated/18000)))
$(eval $(call MakeDir,$(dir build/steepThermalAdvection-slantedCell-cubicUpwind-collated/18000)))
$(eval $(call MakeDir,$(dir build/steepThermalAdvection-cutCell-linearUpwind-collated/18000)))
$(eval $(call MakeDir,$(dir build/steepThermalAdvection-cutCell-cubicUpwind-collated/18000)))

$(eval $(call SteepTerrainCollation,18000/l2errorT.txt,5000 2500 2000 1250 1000 667 500 333 250 125 100))
$(eval $(call SteepTerrainCollation,18000/linferrorT.txt,5000 2500 2000 1250 1000 667 500 333 250 125 100))

.PHONY: all-steepThermalAdvection-convergence all-steepThermalAdvection-maxCourantNumbers
