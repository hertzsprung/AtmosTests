# $1 -- case directory
# $2 -- mesh case
define LinearHorizontalAdvection

$(eval $(call Advection,$1,$2,src/advection/horizontalVelocityField,src/advection/system/linear src/advection/system/commonFvSchemes))

endef

# $1 -- case directory
# $2 -- mesh case
define CubicUpwindHorizontalAdvection

$(eval $(call Advection,$1,$2,src/advection/horizontalVelocityField,src/advection/system/cubicUpwindCPCFit src/advection/system/commonFvSchemes))

endef

# $1 -- case directory
# $2 -- mesh case
define TerrainFollowingAdvection

$(eval $(call Advection,$1,$2,src/advection/terrainFollowingVelocityField,src/advection/system/cubicUpwindCPCFit src/advection/system/commonFvSchemes))

endef

# $1 -- case directory
# $2 -- mesh case
# $3 -- velocityFieldDict
# $4 -- fvSchemes
define Advection

all:: $1/10000/l2errorT.txt $1/10000/minT.txt $1/10000/maxT.txt

$(eval $(call InitialTracer,$1-initialTracer,$2,$3))

$(eval $(call VelocityField,$1-velocity,$2,$3))

$(eval $(call AdvectTracer,$1,$2,$1-initialTracer/0/T,$1-velocity/0/phi,5000 10000,25,1000,$4))

$(eval $(call Tracer,$1-analyticTracer,$2,10000,$3,T_analytic))

$(eval $(call FieldDiff,$1,10000,T,$1-analyticTracer/10000/T_analytic))

$(eval $(call Extrema,$1,10000,T))
$(eval $(call L2Error,$1,10000,T))
$(eval $(call Contour,$1,0,T,$1/0/T.samplePlane,0.1))
$(eval $(call Contour,$1,5000,T,$1/5000/T.samplePlane,0.1))
$(eval $(call Contour,$1,10000,T,$1/10000/T.samplePlane,0.1))
$(eval $(call Contour,$1,10000,T_diff,$1/10000/T_diff.samplePlane,0.01))
$(eval $(call SamplePlane,$1,0,T,src/advection/samplePlane))
$(eval $(call SamplePlane,$1,5000,T,src/advection/samplePlane))
$(eval $(call SamplePlane,$1,10000,T,src/advection/samplePlane))
$(eval $(call SamplePlane,$1,10000,T_diff,src/advection/samplePlane))

endef

# $1 -- case directory
# $2 -- mesh case
# $3 -- initial tracer field
# $4 -- velocity field
# $5 -- times (e.g. 5000 10000)
# $6 -- timestep
# $7 -- writeInterval (must be a multiple of timestep)
# $8 -- fvSchemes file list (the first file must be the fvSchemes file itself, the remainder are copied into $1/system)
define AdvectTracer

.INTERMEDIATE: $1.intermediate

$(addprefix $1/,$(addsuffix /T,$5)): $1.intermediate

$1.intermediate: \
  $(addprefix $1/,$(meshFiles)) \
  $(addprefix $1/,$(systemFiles)) \
  $1/0/T \
  $1/0/phi
	$(advectionFoam) -case $1

# primary fvSchemes file depends upon any auxiliary fvSchemes files
$1/$(fvSchemes): $(addprefix $1/system/,$(notdir $(call rest,$8)))

$(eval $(call CopyNamedFiles,$2,$(meshFiles),$1))
$(eval $(call CopyFile,$3,$1/0/T))
$(eval $(call CopyFile,$4,$1/0/phi))
$(eval $(call ControlDict,$1,$(lastword $5),$6,$7))
$(eval $(call CopyNamedFile,src/advection,$(fvSolution),$1))
$(eval $(call CopyFile,$(firstword $8),$1/$(fvSchemes)))
$(foreach F,$(call rest,$8),$(eval $(call CopyNamedFile,$(dir $F),$(notdir $F),$1/system)))

$(eval $(call MakeDir,$1/$(polyMesh)))
$(eval $(call MakeDir,$1/system))
$(eval $(call MakeDir,$1/0))

endef

# $1 -- case
# $2 -- mesh
# $3 -- velocityFieldDict
define InitialTracer

$(eval $(call Tracer,$1,$2,0,$3,T))

endef

# $1 -- case
# $2 -- mesh
# $3 -- times
# $4 -- velocityFieldDict
# $5 -- field name
define Tracer

.INTERMEDIATE: $1.$5.intermediate

$(addprefix $1/,$(addsuffix /$5,$3)): $1.$5.intermediate

$1.$5.intermediate: \
  $(addprefix $1/,$(meshFiles)) \
  $(addprefix $1/,$(systemFiles)) \
  $1/$(setScalarOverOrographyDict) \
  $1/$(velocityFieldDict) \
  $(setScalarOverOrography) \
| $(addprefix $1/,$3)
	$(setScalarOverOrography) -case $1 -tracerFieldFileName $5

$(eval $(call CopyFile,src/advection/radialTracer,$1/$(setScalarOverOrographyDict)))
$(eval $(call CopyFile,$4,$1/$(velocityFieldDict)))
$(eval $(call CopyNamedFiles,$2,$(meshFiles),$1))
$(eval $(call CopyNamedFiles,$(dummy),$(systemFiles),$1))

$(eval $(call MakeDirs,$(addprefix $1/,$3)))
$(eval $(call MakeDir,$1/$(polyMesh)))
$(eval $(call MakeDir,$1/constant))
$(eval $(call MakeDir,$1/system))

endef

# $1 -- case directory
# $2 -- mesh case
# $3 -- velocityFieldDict
define VelocityField

$1/0/phi: \
  $1/$(velocityFieldDict) \
  $(addprefix $1/,$(meshFiles)) \
  $(addprefix $1/,$(systemFiles)) \
  $(setVelocityField)
	$(setVelocityField) -case $1

$(eval $(call CopyFile,$3,$1/$(velocityFieldDict)))
$(eval $(call CopyNamedFiles,$2,$(meshFiles),$1))
$(eval $(call CopyNamedFiles,$(dummy),$(systemFiles),$1))

$(eval $(call MakeDir,$1/constant))
$(eval $(call MakeDir,$1/system))
$(eval $(call MakeDir,$1/$(polyMesh)))

endef
