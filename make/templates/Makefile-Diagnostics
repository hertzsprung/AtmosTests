# collate files, such as error norms or other statistics, 
# into a single text file, suitable for convergence plots
# outputs a file named $1collated/$2
#
# $1 -- case prefix
# $2 -- case suffix
# $3 -- filename (e.g. 18000/l2errorT.txt)
# $4 -- resolutions
define Collate

$1collated$2/$3: \
  $(foreach R,$4,$1$R$2/$3) \
  $(collate) \
| $(dir $1collated$2/$3)
	$(collate) $1 '$2' $3 $4 > $$@

endef

# collate errors into a single text file, suitable for convergence plots
# outputs a file named $1collated/$2
#
# $1 -- case prefix
# $2 -- error filename (e.g. 18000/l2errorT.txt)
# $3 -- NGRIDs
define CollateErrorsOnSphere

$1collated/$2: \
  $(foreach R,$3,$(addprefix $1,$R/$2)) \
  $(collateSphere) \
  $(addsuffix /meshAverageEquatorialSpacing.txt,$(addprefix $1,$3)) \
| $(dir $1collated/$2)
	$(collateSphere) $1 $2 $3 > $$@

endef


# $1 -- case
define MaxCourantNumber

$1/maxCo.txt: \
  $1/0/phi \
  $(addprefix $1/,$(meshFiles)) \
  $(addprefix $1/,$(systemFiles)) \
  $(courantNumber)
	$(courantNumber) -case $1 | tail -n1 | cut -d' ' -f6 > $$@

endef

# $1 -- case
# $2 -- time
# $3 -- field
define Extrema

$1/$2/min$3.txt $1/$2/max$3.txt: $1/$2/globalSum$3.dat

$1/$2/min$3.txt:
	$(call ExtractStat,$$@,$$<,7)

$1/$2/max$3.txt:
	$(call ExtractStat,$$@,$$<,8)

$(eval $(call GlobalSum,$1,$2,$3))

endef

# $1 -- case
define MeshDiagnostics

$1/meshDiagnostics.txt: \
  $(addprefix $1/,$(meshFiles)) \
  $(addprefix $1/,$(systemFiles))
	$(checkMesh) -case $1 -constant > $$@

$1/meshMinVol.txt \
$1/meshMaxVol.txt: \
  $1/meshDiagnostics.txt

$1/meshMinVol.txt:
	grep "Min volume" $$< | tr -s ' ' | cut -d' ' -f5 | sed 's/.$$$$//' > $$@

$1/meshMaxVol.txt:
	grep "Max volume" $$< | tr -s ' ' | cut -d' ' -f9 | sed 's/.$$$$//' > $$@

$1/meshVolRatio.txt: $1/meshMinVol.txt $1/meshMaxVol.txt
	python3 -c "print($$$$(cat $1/meshMaxVol.txt)/$$$$(cat $1/meshMinVol.txt))" > $$@

$1/meshNonOrthogonality.txt: $1/meshDiagnostics.txt
	grep "Mesh non-orthogonality" $$< | tr -s ' ' | cut -d' ' -f5 > $$@

$1/meshMeanCellCentreDistance.txt: \
  $(addprefix $1/,$(meshFiles)) \
  $(addprefix $1/,$(systemFiles))
	$(cellCentreDistances) -case $1 | tail -n +25 | datamash mean 1 > $$@

$1/meshAverageEquatorialSpacing.txt: \
  $1/meshMeanCellCentreDistance.txt
	python3 -c "import math; print(360*$$$$(cat $1/meshMeanCellCentreDistance.txt) / (2*math.pi*6.3712e6))" > $$@

endef

# $1 -- case
# $2 -- timestep
define AdvectionDiagnostics

$1/0/Co: \
  $1/0/phi \
  $(addprefix $1/,$(meshFiles)) \
  $(addprefix $1/,$(systemFiles))
	$(postProcess) -case $1 -time 0 -func CourantNo

$1/0/maxCo.txt: $1/0/Co
	$(postProcess) -case $1 -time 0 -func "minMaxMagnitude(Co)" | perl -ne '/.*max\(Co\) = (.*) at location.*/ && print $$$$1 and last' > $$@

$1/0/maxdt.txt: $1/0/maxCo.txt
	python3 -c "print($2/$$$$(cat $$<))" > $$@

endef
