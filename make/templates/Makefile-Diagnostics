# collate errors into a single text file, suitable for convergence plots
# outputs a file named $1collated/$2
#
# $1 -- case prefix
# $2 -- error filename (e.g. 18000/l2errorT.txt)
# $3 -- resolutions
define CollateErrors

$1collated/$2: \
  $(foreach R,$3,$(addprefix $1,$R/$2)) \
  $(collate) \
| $(dir $1collated/$2)
	$(collate) $1 $2 $3 > $$@

$(eval $(call MakeDir,$(dir $1collated/$2)))

endef

# $1 -- case
# $2 -- time
# $3 -- field
define Extrema

$1/$2/min$3.txt $1/$2/max$3.txt: $1/$2/globalSum$3.dat

$1/$2/min$3.txt:
	$(call ExtractStat,$$@,$$<,7)

$1/$2/max$3.txt:
	$(call ExtractStat,$$@,$$<,8)

$(eval $(call GlobalSum,$1,$2,$3))

endef

# $1 -- case
define MeshDiagnostics

$1/meshDiagnostics.txt: \
  $(addprefix $1/,$(meshFiles)) \
  $(addprefix $1/,$(systemFiles))
	$(checkMesh) -case $1 -constant > $$@

$1/meshMinVol.txt \
$1/meshMaxVol.txt: \
  $1/meshDiagnostics.txt

$1/meshMinVol.txt:
	grep "Min volume" $$< | tr -s ' ' | cut -d' ' -f5 | sed 's/.$$$$//' > $$@

$1/meshMaxVol.txt:
	grep "Max volume" $$< | tr -s ' ' | cut -d' ' -f9 | sed 's/.$$$$//' > $$@

$1/meshVolRatio.txt: $1/meshMinVol.txt $1/meshMaxVol.txt
	python -c "print $$$$(cat $1/meshMaxVol.txt)/$$$$(cat $1/meshMinVol.txt)" > $$@

$1/meshNonOrthogonality.txt: $1/meshDiagnostics.txt
	grep "Mesh non-orthogonality" $$< | tr -s ' ' | cut -d' ' -f5 > $$@

endef
