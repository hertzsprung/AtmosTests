# $1 -- case directory
# $2 -- mesh case
define TerrainFollowingAdvection

$(eval $(call InitialTracer,$1-initialTracer,$2,-50000))

$(eval $(call TerrainFollowingVelocityField,$1-velocity,$2,src/advection/terrainFollowingVelocityField))

$(eval $(call DivFreeVelocityField,$1-velocity-divFree,$2,$1-velocity/0/Uf))

$(eval $(call Advection,$1,$2,$1-initialTracer/0/T,$1-velocity-divFree/0/phi,5000 10000,25,5000,src/advection/system/cubicUpwindCPCFit src/advection/system/commonFvSchemes))

$(eval $(call Tracer,$1-analyticTracer,$2,51500,10000,T_analytic))

$(eval $(call FieldDiff,$1,10000,T,$1-analyticTracer/10000/T_analytic))

$(eval $(call L2Error,$1,10000,T))

endef

# $1 -- case directory
# $2 -- mesh case
# $3 -- velocityFieldDict
define TerrainFollowingVelocityField

$1/0/Uf: \
  $1/$(velocityFieldDict) \
  $(addprefix $1/,$(meshFiles)) \
  $(addprefix $1/,$(systemFiles)) \
  $(setTerrainFollowingVelocityField)
	$(setTerrainFollowingVelocityField) -case $1

$(eval $(call CopyFile,$3,$1/$(velocityFieldDict)))
$(eval $(call CopyNamedFiles,$2,$(meshFiles),$1))
$(eval $(call CopyNamedFiles,$(dummy),$(systemFiles),$1))

$(eval $(call MakeDir,$1/constant))
$(eval $(call MakeDir,$1/system))
$(eval $(call MakeDir,$1/$(polyMesh)))

endef

# $1 -- case directory
# $2 -- mesh case
# $3 -- initial tracer field
# $4 -- velocity field
# $5 -- times (e.g. 5000 10000)
# $6 -- timestep
# $7 -- writeInterval (must be a multiple of timestep)
# $8 -- fvSchemes file list (the first file must be the fvSchemes file itself, the remainder are copied into $1/system)
define Advection

.INTERMEDIATE: $1.intermediate

$(addprefix $1/,$(addsuffix /T,$5)): $1.intermediate

$1.intermediate: \
  $(addprefix $1/,$(meshFiles)) \
  $(addprefix $1/,$(systemFiles)) \
  $1/0/T \
  $1/0/phi
	$(advectionFoam) -case $1 -usePhi

# primary fvSchemes file depends upon any auxiliary fvSchemes files
$1/$(fvSchemes): $(addprefix $1/system/,$(notdir $(call rest,$8)))

$(eval $(call CopyNamedFiles,$2,$(meshFiles),$1))
$(eval $(call CopyFile,$3,$1/0/T))
$(eval $(call CopyFile,$4,$1/0/phi))
$(eval $(call ControlDict,$1,$(lastword $5),$6,$7))
$(eval $(call CopyNamedFile,src/advection,$(fvSolution),$1))
$(eval $(call CopyFile,$(firstword $8),$1/$(fvSchemes)))
$(foreach F,$(call rest,$8),$(eval $(call CopyNamedFile,$(dir $F),$(notdir $F),$1/system)))

$(eval $(call MakeDir,$1/$(polyMesh)))
$(eval $(call MakeDir,$1/system))
$(eval $(call MakeDir,$1/0))

endef
