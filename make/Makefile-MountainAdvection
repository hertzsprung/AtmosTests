# $1 -- resolution
define MountainAdvectionMeshes

$(eval $(call BlockMesh,build/mountainAdvection-mesh-noOrography-$1,src/mountainAdvection/mesh-noOrography-$1))
$(eval $(call TerrainFollowingMesh,build/mountainAdvection-mesh-btf-6km-$1,build/mountainAdvection-mesh-noOrography-$1,src/mountainAdvection/mesh-btf-6km))
$(eval $(call SlantedCellMesh,build/mountainAdvection-mesh-slantedCell-6km-$1,build/mountainAdvection-mesh-noOrography-$1,src/mountainAdvection/mesh-slantedCell-6km))
$(eval $(call CutCellMesh,build/mountainAdvection-mesh-cutCell-6km-$1,src/mountainAdvection/mesh-cutCell-$1-6km,src/mountainAdvection/createPatchDict))
$(eval $(call TerrainFollowingMesh,build/mountainAdvection-mesh-btf-3km-$1,build/mountainAdvection-mesh-noOrography-$1,src/mountainAdvection/mesh-btf-3km))
$(eval $(call SlantedCellMesh,build/mountainAdvection-mesh-slantedCell-3km-$1,build/mountainAdvection-mesh-noOrography-$1,src/mountainAdvection/mesh-slantedCell-3km))
$(eval $(call CutCellMesh,build/mountainAdvection-mesh-cutCell-3km-$1,src/mountainAdvection/mesh-cutCell-$1-3km,src/mountainAdvection/createPatchDict))

endef

# $1 -- meshType (e.g. btf)
# $2 -- mountain height (e.g. 6km)
# $3 -- resolution
# $4 -- timestep
define MountainAdvectionTests

$(eval $(call Advection,build/mountainAdvection-$1-$2-cubicUpwind-$3,build/mountainAdvection-mesh-$1-$2-$3,src/mountainAdvection/schaerRadial,src/mountainAdvection/velocityField-$2,src/advection/system/cubicUpwindCPCFit,$4,src/mountainAdvection/T_init))
$(eval $(call Advection,build/mountainAdvection-$1-$2-linearUpwind-$3,build/mountainAdvection-mesh-$1-$2-$3,src/mountainAdvection/schaerRadial,src/mountainAdvection/velocityField-$2,src/advection/system/linearUpwind,$4,src/mountainAdvection/T_init))

endef

# $1 -- error filename
# $2 -- resolutions
define MountainAdvectionCollation

$(eval $(call Collate,build/mountainAdvection-btf-6km-linearUpwind-,$1,$2))
$(eval $(call Collate,build/mountainAdvection-btf-6km-cubicUpwind-,$1,$2))
$(eval $(call Collate,build/mountainAdvection-slantedCell-6km-linearUpwind-,$1,$2))
$(eval $(call Collate,build/mountainAdvection-slantedCell-6km-cubicUpwind-,$1,$2))
$(eval $(call Collate,build/mountainAdvection-cutCell-6km-linearUpwind-,$1,$2))
$(eval $(call Collate,build/mountainAdvection-cutCell-6km-cubicUpwind-,$1,$2))

all-mountainAdvection-convergence: \
  build/mountainAdvection-btf-6km-linearUpwind-collated/$1 \
  build/mountainAdvection-btf-6km-cubicUpwind-collated/$1 \
  build/mountainAdvection-slantedCell-6km-linearUpwind-collated/$1 \
  build/mountainAdvection-slantedCell-6km-cubicUpwind-collated/$1 \
  build/mountainAdvection-cutCell-6km-linearUpwind-collated/$1 \
  build/mountainAdvection-cutCell-6km-cubicUpwind-collated/$1

endef

$(eval $(call MountainAdvectionMeshes,5000))
$(eval $(call MountainAdvectionMeshes,2500))
$(eval $(call MountainAdvectionMeshes,2000))
$(eval $(call MountainAdvectionMeshes,1250))
$(eval $(call MountainAdvectionMeshes,1000))
$(eval $(call MountainAdvectionMeshes,667))
$(eval $(call MountainAdvectionMeshes,500))
$(eval $(call MountainAdvectionMeshes,333))
$(eval $(call MountainAdvectionMeshes,250))
$(eval $(call MountainAdvectionMeshes,125))

$(eval $(call MountainAdvectionTests,btf,3km,1000,10))
$(eval $(call MountainAdvectionTests,slantedCell,3km,1000,5))
$(eval $(call MountainAdvectionTests,cutCell,3km,1000,1))

$(eval $(call MountainAdvectionTests,btf,6km,5000,200))
$(eval $(call MountainAdvectionTests,btf,6km,2500,100))
$(eval $(call MountainAdvectionTests,btf,6km,2000,100))
$(eval $(call MountainAdvectionTests,btf,6km,1250,50))
$(eval $(call MountainAdvectionTests,btf,6km,1000,10))
$(eval $(call MountainAdvectionTests,btf,6km,667,25))
$(eval $(call MountainAdvectionTests,btf,6km,500,20))
$(eval $(call MountainAdvectionTests,btf,6km,333,10))
$(eval $(call MountainAdvectionTests,btf,6km,250,10))
$(eval $(call MountainAdvectionTests,btf,6km,125,5))

$(eval $(call MountainAdvectionTests,slantedCell,6km,5000,50))
$(eval $(call MountainAdvectionTests,slantedCell,6km,2500,20))
$(eval $(call MountainAdvectionTests,slantedCell,6km,2000,10))
$(eval $(call MountainAdvectionTests,slantedCell,6km,1250,10))
$(eval $(call MountainAdvectionTests,slantedCell,6km,1000,5))
$(eval $(call MountainAdvectionTests,slantedCell,6km,667,5))
$(eval $(call MountainAdvectionTests,slantedCell,6km,500,2.5))
$(eval $(call MountainAdvectionTests,slantedCell,6km,333,2))
$(eval $(call MountainAdvectionTests,slantedCell,6km,250,1))
$(eval $(call MountainAdvectionTests,slantedCell,6km,125,0.5))

$(eval $(call MountainAdvectionTests,cutCell,6km,5000,3.2))
$(eval $(call MountainAdvectionTests,cutCell,6km,2500,1.6))
$(eval $(call MountainAdvectionTests,cutCell,6km,2000,1))
$(eval $(call MountainAdvectionTests,cutCell,6km,1250,1))
$(eval $(call MountainAdvectionTests,cutCell,6km,1000,1))
$(eval $(call MountainAdvectionTests,cutCell,6km,667,0.4))
$(eval $(call MountainAdvectionTests,cutCell,6km,500,0.4))
$(eval $(call MountainAdvectionTests,cutCell,6km,333,0.2))
$(eval $(call MountainAdvectionTests,cutCell,6km,250,0.2))
$(eval $(call MountainAdvectionTests,cutCell,6km,125,0.1))

$(eval $(call MakeDir,build/mountainAdvection-btf-6km-linearUpwind-collated/0/))
$(eval $(call MakeDir,build/mountainAdvection-btf-6km-cubicUpwind-collated/0/))
$(eval $(call MakeDir,build/mountainAdvection-slantedCell-6km-linearUpwind-collated/0/))
$(eval $(call MakeDir,build/mountainAdvection-slantedCell-6km-cubicUpwind-collated/0/))
$(eval $(call MakeDir,build/mountainAdvection-cutCell-6km-linearUpwind-collated/0/))
$(eval $(call MakeDir,build/mountainAdvection-cutCell-6km-cubicUpwind-collated/0/))
$(eval $(call MakeDir,build/mountainAdvection-btf-6km-linearUpwind-collated/10000/))
$(eval $(call MakeDir,build/mountainAdvection-btf-6km-cubicUpwind-collated/10000/))
$(eval $(call MakeDir,build/mountainAdvection-slantedCell-6km-linearUpwind-collated/10000/))
$(eval $(call MakeDir,build/mountainAdvection-slantedCell-6km-cubicUpwind-collated/10000/))
$(eval $(call MakeDir,build/mountainAdvection-cutCell-6km-linearUpwind-collated/10000/))
$(eval $(call MakeDir,build/mountainAdvection-cutCell-6km-cubicUpwind-collated/10000/))

$(eval $(call MountainAdvectionCollation,10000/l2errorT.txt,5000 2500 1250 1000 500))
$(eval $(call MountainAdvectionCollation,10000/linferrorT.txt,5000 2500 1250 1000 500))
$(eval $(call MountainAdvectionCollation,0/maxdt.txt,5000 2500 2000 1250 1000 667 500 333 250 125))
